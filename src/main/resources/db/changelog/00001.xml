<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="00001" author="Urmit Kotadiya">
        <createTable tableName="users">
            <column name="user_id" type="bigint">
                <constraints primaryKey="true" />
            </column>
            <column name="first_name" type="varchar(50)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="last_name" type="varchar(50)" />
            <column name="hashed_password" type="varchar(70)" >
                <constraints nullable="false" />
            </column>
            <column name="is_password_change_required" type="boolean" defaultValue="true" >
                <constraints nullable="false" />
            </column>
            <column name="phone_number" type="bigint">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="email" type="varchar(30)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="bigint" defaultValue="1"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="current_timestamp"/>
            <column name="updated_by" type="bigint"/>
        </createTable>

        <createSequence sequenceName="user_id_auto_generate" startValue="2" incrementBy="1"/>
        <addDefaultValue tableName="users" columnName="user_id" defaultValueSequenceNext="user_id_auto_generate"/>

        <createTable tableName="roles">
            <column name="role_id" type="bigint" >
                <constraints primaryKey="true" />
            </column>
            <column name="role_name" type="varchar(50)">
                <constraints unique="true" nullable="false" />
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="bigint" defaultValue="1"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="current_timestamp"/>
            <column name="updated_by" type="bigint"/>
        </createTable>

        <createSequence sequenceName="role_id_auto_generate" startValue="2" incrementBy="1"/>
        <addDefaultValue tableName="roles" columnName="role_id" defaultValueSequenceNext="role_id_auto_generate"/>

        <createTable tableName="user_roles">
            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="role_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="bigint" defaultValue="1"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="current_timestamp"/>
            <column name="updated_by" type="bigint"/>
        </createTable>
        <addPrimaryKey tableName="user_roles" columnNames="user_id,role_id" />
        <addForeignKeyConstraint baseTableName="user_roles" baseColumnNames="user_id" constraintName="fk_user_id" referencedTableName="users" referencedColumnNames="user_id" />
        <addForeignKeyConstraint baseTableName="user_roles" baseColumnNames="role_id" constraintName="fk_role_id" referencedTableName="roles" referencedColumnNames="role_id"/>

        <createTable tableName="permissions">
            <column name="permission_id" type="bigint">
                <constraints primaryKey="true" />
            </column>
            <column name="permission_name" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="scope" type="varchar(30)" />
            <column name="created_at" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="bigint" defaultValue="1"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="current_timestamp"/>
            <column name="updated_by" type="bigint"/>
        </createTable>

        <createSequence sequenceName="permission_id_auto_generate" startValue="2" incrementBy="1"/>
        <addDefaultValue tableName="permissions" columnName="permission_id" defaultValueSequenceNext="permission_id_auto_generate"/>

        <createTable tableName="role_permissions">
            <column name="role_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="permission_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="created_at" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false" />
            </column>
            <column name="created_by" type="bigint" defaultValue="1"/>
            <column name="updated_at" type="timestamp" defaultValueComputed="current_timestamp"/>
            <column name="updated_by" type="bigint"/>
        </createTable>
        <addPrimaryKey tableName="role_permissions" columnNames="role_id,permission_id" />
        <addForeignKeyConstraint baseTableName="role_permissions" baseColumnNames="role_id" constraintName="fk_role_id_perm" referencedTableName="roles" referencedColumnNames="role_id" />
        <addForeignKeyConstraint baseTableName="role_permissions" baseColumnNames="permission_id" constraintName="fk_permission_id" referencedTableName="permissions" referencedColumnNames="permission_id" />

    </changeSet>
    
    <changeSet id="2" author="Urmit Kotadiya">
        <insert tableName="permissions">
            <column name="permission_id" valueNumeric="1" />
            <column name="permission_name" value="USER_CREATE" />
            <column name="scope" value="ADMIN PANEL" />
            <column name="created_by" valueNumeric="1" />
            <column name="updated_by" valueNumeric="1" />
        </insert>

        <insert tableName="roles">
            <column name="role_id" valueNumeric="1" />
            <column name="role_name" value="ADMIN" />
            <column name="created_by" valueNumeric="1" />
            <column name="updated_by" valueNumeric="1" />
        </insert>

        <insert tableName="users">
            <column name="user_id" valueNumeric="1" />
            <column name="first_name" value="Ramesh" />
            <column name="last_name" value="Vaghasiya" />
            <column name="hashed_password" value="$2a$12$6fHmgtMbHyg3eOJ.zDmIeeMQjFjpIxq7Mr0eb8v/wLt0BYUv/jKKO" />
            <column name="is_password_change_required" value="false" />
            <column name="phone_number" valueNumeric="9724567235" />
            <column name="email" value="ramesh123@gmail.com" />
            <column name="created_by" valueNumeric="0" />
            <column name="updated_by" valueNumeric="0" />
        </insert>

        <insert tableName="role_permissions">
            <column name="role_id" valueNumeric="1" />
            <column name="permission_id" valueNumeric="1" />
            <column name="created_by" valueNumeric="1" />
            <column name="updated_by" valueNumeric="1" />
        </insert>

        <insert tableName="user_roles">
            <column name="user_id" valueNumeric="1" />
            <column name="role_id" valueNumeric="1" />
            <column name="created_by" valueNumeric="1" />
            <column name="updated_by" valueNumeric="1" />
        </insert>
    </changeSet>


</databaseChangeLog>